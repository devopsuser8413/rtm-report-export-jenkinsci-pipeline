// ======================================================================
// üß© Jenkins Pipeline: RTM Test Execution Report Automation
// ----------------------------------------------------------------------
// This pipeline automates the following workflow:
//   1Ô∏è‚É£ Exports RTM Test Execution Report (via Selenium headless browser)
//   2Ô∏è‚É£ Publishes exported report to Confluence space
//   3Ô∏è‚É£ Sends email notification with the report attached
// ----------------------------------------------------------------------
// Compatible with: Windows Jenkins Agent
// Prerequisites: Chrome + ChromeDriver + Python 3 installed on agent
// ======================================================================

pipeline {

  agent any
  options { 
    timestamps() 
    ansiColor('xterm')
  }

  // ---------------------------------------------------------------
  // üîß Pipeline Parameters
  // ---------------------------------------------------------------
  parameters {
    string(name: 'RTM_PROJECT',    defaultValue: 'RTM-DEMO', description: 'RTM Project Key')
    string(name: 'TEST_EXECUTION', defaultValue: 'RD-4',     description: 'RTM Test Execution Key')
    choice(name: 'REPORT_FORMAT',  choices: ['pdf'],         description: 'Export format (RTM Cloud supports PDF only)')
  }

  // ---------------------------------------------------------------
  // üåç Environment Configuration (Credentials from Jenkins)
  // ---------------------------------------------------------------
  environment {
    // --- Jira / RTM ---
    JIRA_BASE = credentials('jira-base')          // e.g. https://yourcompany.atlassian.net
    JIRA_USER = credentials('jira-user')
    JIRA_PASS = credentials('jira-pass')

    // --- Confluence ---
    CONFLUENCE_BASE  = credentials('confluence-base')
    CONFLUENCE_USER  = credentials('confluence-user')
    CONFLUENCE_TOKEN = credentials('confluence-token')
    CONFLUENCE_SPACE = 'DEV'
    CONFLUENCE_TITLE = "Test Execution Report ‚Äì ${RTM_PROJECT}/${TEST_EXECUTION}"

    // --- Email ---
    SMTP_HOST   = credentials('smtp-host')
    SMTP_PORT   = '587'
    SMTP_USER   = credentials('smtp-user')
    SMTP_PASS   = credentials('smtp-pass')
    REPORT_FROM = credentials('sender-email')
    REPORT_TO   = credentials('multi-receivers')  // Comma-separated recipients

    // --- Python UTF-8 support ---
    PYTHONIOENCODING = 'utf-8'
  }

  // ---------------------------------------------------------------
  // üö¶ Pipeline Stages
  // ---------------------------------------------------------------
  stages {

    // -------------------------------------------------------------
    // Stage 1: Checkout Repository
    // -------------------------------------------------------------
    stage('Checkout Source Code') {
      steps {
        echo "üîÑ Checking out source code from Git repository..."
        checkout scm
      }
    }

    // -------------------------------------------------------------
    // Stage 2: Setup Python Virtual Environment
    // -------------------------------------------------------------
    stage('Setup Python Environment') {
      steps {
        echo "üêç Setting up Python virtual environment..."
        bat """
          if not exist .venv python -m venv .venv
          .venv\\Scripts\\python -m pip install --upgrade pip
          .venv\\Scripts\\pip install selenium requests
        """
      }
    }

    // -------------------------------------------------------------
    // Stage 3: Export RTM Report via Selenium
    // -------------------------------------------------------------
    stage('Export RTM Report (Selenium)') {
      steps {
        script {
          echo "üöÄ Starting RTM report export for ${params.RTM_PROJECT}/${params.TEST_EXECUTION}..."

          // Run Selenium script
          bat """
            set DOWNLOAD_DIR=report
            .venv\\Scripts\\python scripts\\rtm_export_selenium.py > export.out 2>&1
          """

          // Parse export logs
          def output = readFile('export.out')
          echo output

          // Extract the downloaded PDF path
          def m = (output =~ /Found report: (.+\\.pdf)/)
          if (!m) {
            error "‚ùå Export failed ‚Äî no PDF found in export.out logs!"
          }
          env.REPORT_FILE = m[0][1].trim()
          echo "‚úÖ RTM report successfully downloaded: ${env.REPORT_FILE}"
        }
      }

      post {
        success {
          echo "üì¶ Archiving generated RTM PDF report..."
          archiveArtifacts artifacts: 'report/**/*.pdf', fingerprint: true
        }
        failure {
          echo "‚ö†Ô∏è RTM export stage failed ‚Äî check export.out for errors."
        }
      }
    }

    // -------------------------------------------------------------
    // Stage 4: Publish Report to Confluence
    // -------------------------------------------------------------
    stage('Publish to Confluence') {
      steps {
        script {
          echo "üì§ Publishing RTM report to Confluence..."

          def title = "RTM Test Execution Report ‚Äì ${params.RTM_PROJECT}/${params.TEST_EXECUTION}"
          def body  = """
          <p>Automated RTM Test Execution report for <b>${params.RTM_PROJECT}/${params.TEST_EXECUTION}</b>.</p>
          <p>Generated via Jenkins Selenium pipeline.</p>
          """

          bat """
            .venv\\Scripts\\pip install requests
            .venv\\Scripts\\python scripts\\confluence_publish.py ^
              --space "%CONFLUENCE_SPACE%" ^
              --title "${title}" ^
              --body "${body}" ^
              --attach "%REPORT_FILE%"
          """
        }
      }
    }

    // -------------------------------------------------------------
    // Stage 5: Send Email Notification
    // -------------------------------------------------------------
    stage('Email Notification') {
      steps {
        script {
          echo "üìß Sending email notification with RTM report attachment..."

          def subject = "RTM Test Execution Report ‚Äì ${params.RTM_PROJECT}/${params.TEST_EXECUTION}"
          def body = """Hi Team,

The RTM Test Execution report for project **${params.RTM_PROJECT}**, execution **${params.TEST_EXECUTION}**
has been successfully generated, published to Confluence, and is attached to this email.

Regards,
Jenkins Automated Pipeline
"""
          writeFile file: 'email_body.txt', text: body
        }

        bat """
          .venv\\Scripts\\python scripts\\send_email.py ^
            --subject "RTM Test Execution Report ‚Äì %RTM_PROJECT%/%TEST_EXECUTION%" ^
            --body "email_body.txt" ^
            --to "%REPORT_TO%" ^
            --attach "%REPORT_FILE%"
        """
      }
    }
  }

  // ---------------------------------------------------------------
  // üßæ Post Actions
  // ---------------------------------------------------------------
  post {
    always {
      echo 'üìú Pipeline execution completed.'
    }
    success {
      echo '‚úÖ RTM Report exported, published to Confluence, and emailed successfully.'
    }
    failure {
      echo '‚ùå Pipeline failed ‚Äî please review Jenkins console logs and export.out.'
    }
  }
}
